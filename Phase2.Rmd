---
title: "Final Project"
output:
  html_document: default
  pdf_document: default
date: "2024-04-16"
---
#################################################

**Updated:**    
**DateSet1:**   
2024-04-16
1): Finish  descriptive statistics  
2): Finish dataset Visulation  
3): Finish parts of ANOVA(with Post- hoc test), T-Test  
4): (linear/logistic) model- Finish Linear Model of age and charges, Linear Model of bmi and charges  
5): Question !!! So, to seperate the column to do ANOVA or combine all columns to do ANOVA??  (3.2 &3.5)     

2024-04-22
1) Organzie ANOVA 
2) Make a correleation matrix
3) To do a linear regression model in 3D plot


**DateSet2:**  
2024-04-16
1: Finish  descriptive statistics  

2024-04-22
1) Remove dataset2

2024-05-02
1) Update the graph:Linear Model of age and charges
2) Update the graph:Linear Model by BMI_Group
3) Update the graph:3D graph
4) Update Model for linear regression
5) Add the interpretation


2020-05-05
1) bmi chart (change x, y)
2)Table Descriptive Statistics Update
################################################




```{r}
#update.packages(ask = FALSE)
#install.packages("dplyr")
#install.packages("corrplot")
```


## Dataset1 
Connect to MySQL and Select the data we want to use as df in R.
```{r}
#install and load Packages.

#install.packages("RMySQL")
library(RMySQL) 
library(DBI)
library(RMySQL) 


# Load ggplot library
library(ggplot2)

```

```{r}
con <-dbConnect(MySQL(),
#host='127.0.0.1',
#user='root',
#password='12345678',
#dbname='HDS_R_Final')

host = 'srv1389.hstgr.io',
user = 'u721770684_root',
password ='HDShds1234',
dbname = 'u721770684_HDS_test')

```


```{r}
# Load dataset1
test_data <-dbGetQuery(con,"
SELECT
	A.age,
	A.bmi,
	A.charges,
	A.children,
	A.region,
	A.sex,
	A.smoker,
  CASE
		-- make sure how to define age group? any studies or refeerence?
		-- now: <18, 18-29, 30-44, 45-64
		WHEN A.age < 18 THEN 'Age<18' 
		WHEN A.age >= 18 AND A.age < 30 THEN'Age18-29'
		WHEN A.age >= 30 AND A.age <45 THEN 'Age30-44'
		WHEN A.age >= 45 AND A.age <65 THEN 'Age45-64'
		WHEN A.age >65 THEN 'Age>65'
		
		ELSE 'NA' 
			END AS 'Age_Group',
			
	CASE
			-- bmi groups REFERENCES: https://www.cdc.gov/healthyweight/assessing/bmi/adult_bmi/index.html
			WHEN A.bmi < 18.5 THEN 'Underweight'
			WHEN A.bmi >=18.5 AND A.bmi<24.9 THEN 'Healthy Weight'
			WHEN A.bmi >=24.9 AND A.bmi<29.9 THEN 'Overweight'
			WHEN A.bmi >=29.0 THEN 'Obesity'
			ELSE 'NA'
		END AS 'BMI_Group'
	
FROM
	insurance A;
")
df <- as.data.frame(test_data) #convert to dataframe
#print(df)

head(df, 10)


```

```{r}
#Clean data:Remove NA

df <- na.omit(df)

head(df,10)

```

```{r}
#Recode: columns needs to turn to 0.1 2 3 4 format to do anaylize

# Age_c columns
df$age_c <- 0  # Create a new column and initialize all values to 0
df$age_c[df$Age_Group == 'Age18-29'] <- 1
df$age_c[df$Age_Group == 'Age30-44'] <- 2  # Replace with 2 where age is '30-44'
df$age_c[df$Age_Group == 'Age45-64'] <- 3  # Replace with 3 where age is '45-64'
df$age_c[df$Age_Group == 'Age>65'] <- 4 # Replace with 4 where age is lager than 65

#region_c columns
df$region_c[df$region == 'southwest'] <-0 
df$region_c[df$region == 'southeast'] <-1
df$region_c[df$region == 'northwest'] <-2
df$region_c[df$region == 'northeast'] <-3

#BMI_group columns
df$bmi_group_c[df$BMI_Group == 'Underweight'] <-0
df$bmi_group_c[df$BMI_Group == 'Healthy Weight'] <-1
df$bmi_group_c[df$BMI_Group == 'Overweight'] <-2
df$bmi_group_c[df$BMI_Group == 'Obesity'] <-3

#sex_c columns
df$sex_c[df$sex == 'female'] <-0
df$sex_c[df$sex == 'male'] <-1

#smoker column

df$smoker_c[df$smoker =='no'] <-0
df$smoker_c[df$smoker =='yes']  <-1

head(df,10)
```
```{r}
df_clean <- subset(df, select = c("age", "bmi","sex_c","smoker_c", "charges"))

head(df_clean,10)
```


```{r}
#install.packages("tldr")
#install.packages("knitr")
#install.packages("tableone")

```




### #1)Descriptive statistics for research question 1
### Phase3 -3a) model 1
```{r}
#summary_stats <- summary(test_data)
#print(test_data)

library(dplyr)
library(tidyr)

dataset1_summary <- test_data %>% 
  select(where(is.numeric)) %>% 
  summary()

print(dataset1_summary)


# Calculating summary statistics for BMI and Charges
summary_df <- df %>%
  summarise(
    BMI_min = round(min(bmi, na.rm = TRUE),2),
    BMI_Median = round(median(bmi, na.rm = TRUE),2),
    BMI_Mean = round(mean(bmi, na.rm = TRUE),2),
    BMI_SD = round(sd(bmi, na.rm = TRUE),2),
    BMI_Q1 = round(quantile(bmi, 0.25, na.rm = TRUE),2),
    BMI_Q3 = round(quantile(bmi, 0.75, na.rm = TRUE),2),
    BMI_max = round(max(bmi, na.rm = TRUE),2),
    
    Age_min = round(min(age, na.rm = TRUE),2),
    Age_Median = round(median(age, na.rm = TRUE),2),
    Age_Mean = round(mean(age, na.rm = TRUE),2),
    Age_SD = round(sd(age, na.rm = TRUE),2),
    Age_Q1 = round(quantile(age, 0.25, na.rm = TRUE),2),
    Age_Q3 = round(quantile(age, 0.75, na.rm = TRUE),2),
    Age_max = round(max(age, na.rm = TRUE),2),
    
    children_min = round(min(children, na.rm = TRUE),2),
    children_Median = round(median(children, na.rm = TRUE),2),
    children_Mean = round(mean(children, na.rm = TRUE),2),
    children_SD = round(sd(children, na.rm = TRUE),2),
    children_Q1 = round(quantile(children, 0.25, na.rm = TRUE),2),
    children_Q3 = round(quantile(children, 0.75, na.rm = TRUE),2),
    children_max = round(max(children, na.rm = TRUE),2),
    
    
    
    Charges_min = round(min(charges, na.rm = TRUE),2),
    Charges_Median = round(median(charges, na.rm = TRUE),2),
    Charges_Mean = round(mean(charges, na.rm = TRUE),2),
    Charges_SD = round(sd(charges, na.rm = TRUE),2),
    Charges_Q1 = round(quantile(charges, 0.25, na.rm = TRUE),2),
    Charges_Q3 = round(quantile(charges, 0.75, na.rm = TRUE),2),
    Charges_max = round(max(charges, na.rm = TRUE),2),
    
    
  ) %>%
  pivot_longer(
    cols = everything(),
    names_to = c("Variable", ".value"),
    names_pattern = "(.*)_(.*)"
  )

# Viewing the transformed summary
print(summary_df)



```

```{r}
library(dplyr)
library(knitr)
library(kableExtra)


# Assuming test_data is your dataset
#dataset1_summary <- summary_df %>% 
#  select(where(is.numeric)) %>% 
#  summary()


# Using kable to create a formatted table and make headers bold
kable(summary_df, format = "html", caption = "Descriptive Statistics") %>%
  kable_styling(full_width = FALSE, font_size = 12) %>%
  row_spec(0, bold = TRUE, background = "#D3D3D3") %>%  # Making header row bold and giving it a background color
  column_spec(1, width = "10em") %>%  # Adjust the width for the Variable name column
  column_spec(2:8, width = "5em")  # Adjust the width for each statistics column
```





```{r}
# 2.1)histogram (bmi_group) and scatter plot (bmi)

#Create normal normal histogram
# # Histogram for BMI
# ggplot(df, aes(x=bmi)) +
#   geom_histogram(binwidth = 1, fill="blue", color="black") +
#   ggtitle("Histogram of BMI") +
#   xlab("BMI") +
#   ylab("Frequency")


# Create the histogram by BMI_Group
ggplot(df, aes(x = bmi, fill = BMI_Group)) +
  geom_histogram(binwidth = 1, color = "black") +
  scale_fill_manual(values = c("Underweight" = "yellow", "Healthy Weight" = "blue", "Overweight" = "orange", "Obesity" = "red")) +
  ggtitle("Histogram of BMI_Group") +
  xlab("BMI") +
  ylab("Frequency")


#scatter plot
# Scatter plot for BMI vs Charges
ggplot(df, aes(x= charges, y=bmi)) +
  geom_point(color="purple") +
  ggtitle("Scatter Plot of Charges vs BMI") +
  xlab("Charges") +
  ylab("BMI")


```

```{r}
# 2.2)histogram (age_group) and scatter plot(age) 

ggplot(df, aes(x = age, fill = Age_Group)) +
  geom_histogram(binwidth = 1, color = "black") +
  scale_fill_manual(values = c("Age<18" = "yellow",'Age18-29' = 'Red', "Age30-44" = "blue", "Age45-64" = 'Green', "Age >65" = 'Purple')) +
  ggtitle("Histogram of Age_Group") +
  xlab("Age_group") +
  ylab("Frequency")
#scatter plot
# Scatter plot for age vs Charges
ggplot(df, aes(x=age, y=charges)) +
  geom_point(color="purple") +
  ggtitle("Scatter Plot of Charges vs Age") +
  xlab("age") +
  ylab("Charges")

```

```{r}
# 2.3)bar chart (sex) and violin plot(sex)

# bar chart
ggplot(df, aes(x=sex, y=charges, fill=sex)) +
    geom_bar(stat="summary", fun=mean) +
    labs(title="Average Insurance Fee by Gender", x="Gender", y="Average Insurance Fee")

#Violin plot
ggplot(df, aes(x=sex, y=charges, fill=sex)) +
    geom_violin() +
    labs(title="Insurance Fee Distribution by Gender", x="Gender", y="Insurance Fee")
```

```{r}
# 2.4) smoke plot

# bar chart
ggplot(df, aes(x=smoker, y=charges, fill=smoker)) +
    geom_bar(stat="summary", fun=mean) +
    scale_fill_manual(values=c("no"="blue", "yes"="red")) +   # change colors
    labs(title="Average Insurance Fee by smoker", x="smoker", y="Average Insurance Fee")

#Violin plot
ggplot(df, aes(x=smoker, y=charges, fill=smoker)) +
    geom_violin() +
    scale_fill_manual(values=c("no"="blue", "yes"="red")) +   # change colors
    labs(title="Insurance Fee Distribution by smoker", x="smoker", y="Insurance Fee")

```



```{r}
# 2.5) region plot

ggplot(df, aes(x=Age_Group, y=charges)) + 
  geom_point() + 
  facet_wrap(~region) + 
  ggtitle("Insurance charges by Region with respect to Age_Group") +
  xlab("Age_Group") + 
  ylab("charges")


ggplot(df, aes(x=region, y=charges,fill=region)) + 
  geom_boxplot() + 
  ggtitle("Distribution of Insurance charges by Region") +
  scale_fill_manual(values = c("northeast" = "yellow", "northwest" = "blue", "southeast" = "orange", "southwest" = "red")) +
  xlab("Region") + 
  ylab("charges")


ggplot(df, aes(x=sex, y=charges)) + 
  geom_point() + 
  facet_wrap(~region) + 
  ggtitle("Insurance charges by Region with respect to sex") +
  xlab("Sex") + 
  ylab("charges")

ggplot(df, aes(x=sex, y=charges,fill=region)) + 
  geom_boxplot() + 
  ggtitle("Distribution of Insurance charges by Region_sex") +
  scale_fill_manual(values = c("northeast" = "yellow", "northwest" = "blue", "southeast" = "orange", "southwest" = "red")) +
  xlab("Region") + 
  ylab("charges")
  
```



``` {r}
# 3.1) ANOVA for all (Age_group, bmi_group,region) --> if significant , to do post- hoc test (3.4 can get more explantion)
anova_result <- aov(charges ~ BMI_Group +Age_Group+region , data = df)
summary(anova_result)

#Post- hoc test example code:
#pairwise.t.test(df$charges, df$BMI_Group, p.adjust.method = "bonferroni")
#pairwise.t.test(df$charges, df$Age_Group, p.adjust.method = "bonferroni")
```

In this ANOVA analysis, BMI_Group and Age_Group show statistically significant differences in the variable being analyzed, indicating that the means of these groups differ. However, the region does not show a significant difference (p-value 0.107), suggesting that the means for different regions might not significantly differ.


```{r}
# 3.2) ANVOVA for Age_group and charges.
# When doing ANOVA, it does not need to recode the data to 1.2.3.4.... Thus, just using the original column.

anova_result_age <- aov(charges ~ Age_Group , data = df)
summary(anova_result_age)


#because of significant result, so doing Post- hoc test
pairwise.t.test(df$charges, df$Age_Group, p.adjust.method = "bonferroni")
```

In this ANOVA analysis,it shows significant differences given the F value and extremely low p-value (p < 2e-16). Every comparison between pairs is statistically significant, suggesting clear variations in charges across various age groups after accounting for multiple comparisons using the Bonferroni technique. These findings indicate that age has a substantial impact on the variable 'charges', and each age group exhibits a statistically distinct average charge. This underscores the need of implementing customized financial plans or policies for various age groups.



```{r}
# 3.3) ANVOVA for bmi and charges.


anova_result_bmi <- aov(charges ~ BMI_Group , data = df)
summary(anova_result_bmi)


#because of significant result, so doing Post- hoc test
pairwise.t.test(df$charges, df$BMI_Group, p.adjust.method = "bonferroni")

```
This ANOVA is to evaluate if there are significant differences in charges across different BMI categories. The result is significant differences, with the F value being 17.9 and the p-value very small (2.17e-11). In addition, given the significant ANOVA results, a post-hoc test (pairwise.t.test) is conducted to determine which specific BMI categories differ in terms of charges. The result shows that "Obesity vs. Healthy Weight" and "Obesity vs. Overweight" are significant different.


```{r}
# 3.4) ANOVA for region.

anova_result_region <- aov(charges ~ region, data = df)
summary(anova_result_region)
# p-value =0.0309 (P<.05)

#Because the result is significant, to do post hoc test to get details. ANOVA only can test if there is significant between regions. Post-hoc can know more details (such as any 2 regions.)


#because of significant result, so doing Post- hoc test
pairwise.t.test(df$charges, df$region, p.adjust.method = "bonferroni")

#the result of post-hoc test: there is no p-value < 0.05. It means that after Post hoc test, the details actually are not significant.
```
Ihis ANOVA is  to check if there are significant differences in charges across different regions. The result indicates that it is significant difference (p-value =0.0309). However, after post-hoc test, there is  no single pair shows a statistically significant difference after adjusting for multiple comparisons.


```{r}
# 3.5)  T-test for sex and charges.
# before T-test, the data should convert to binary(0.1) format
# 1 = male, 0 = female

# Perform a t-test to compare charges between males and females
t_test_result_sex <- t.test(charges ~ sex_c, data = df)

# Print the results
print(t_test_result_sex)

```

The t-test has returned a p-value of 0.03584, which is below the conventional alpha level of 0.05, indicating that there is a statistically significant difference in mean charges between the two groups.

The confidence interval for the difference in means does not include zero (91.85535 to 2682.48932), which supports the finding that the difference is significant.


```{r}
# 3.6)  T-test for smoke.
# before T-test, the data should convert to binary(0.1) format
# 0 = yes, 1 = no

t_test_result_smoke <- t.test(charges ~ smoker_c, data = df)

# Print the results
print(t_test_result_smoke)

```

T-test is used to test the hypothesis that two populations(smokers vs non-smokers) have equal means. The result is significant different (p< 2.2e-16). It provides strong evidence against the null hypothesis that the means of the two groups are equal.



```{r}
#Correlation Matrix

# Ensure the data frame only are all numeric
numeric_df <- df_clean[sapply(df_clean, is.numeric)]

#correlation matrix
cor_matrix <- cor(numeric_df)

# Print the correlation matrix
print(cor_matrix)

```



```{r}
# 7) Model for linear regression


# charges vs bmi
model_BMI_Group <- lm(charges ~ bmi , data = df)
summary(model_BMI_Group) 

# charges vs Region -> does not have sigificant result 


# charge vs all
model_all <- lm(charges ~ age+bmi+sex+smoker , data = df)
summary(model_all) 

# Compare the small models and large model
anova(model_BMI_Group,model_all)

# Interpreation: 'model_all' is best than other two model, because the result of the p-value is sinigicant.
```

The linear regression of the all variables which have siginificant diffence result: 
The result shows that "age", "bmi", and "smoker_yes" are significant in coefficients. R-squared is around 74%. It indicates that approximately 74.75% of the variance in the charge amounts could be explained by the model's predictors (age, BMI, sex, and smoking status). 
The F-statistic is 986.5 on 4 and 1333 DF with a p-value < 2.2e-16, strongly suggesting that the model as a whole is statistically significant.

```{r}

library(ggplot2)

#Linear Model of age and charges
ggplot(df, aes(x = age, y = charges)) + 
  geom_point(color ="blue") + 
  geom_smooth(method = "lm", se = FALSE, aes(color = "Linear fit line")) +
  theme_minimal()+
  labs(title = "Linear Model Fit", x = "Age", y = "Charges")



#Linear Model of bmi and charges
ggplot(df, aes(x = charges, y = bmi))+ 
  geom_point(aes(color = BMI_Group))+ 
  labs(title = "Linear Model by BMI_Group", x = "charges", y = "BMI")+
  theme_minimal()+
  geom_smooth(method = "lm", se = TRUE, aes(color = "Linear fit line"))

```



```{r}
library(plotly)

# From the correlation, we can see that 'smoker' has strong correlation with charge. Thus, we can do a model which select 'non-smoker' and find the relation between 'age', bmi' and 'charge'.


# Filter non-smoker data
non_smoker_df <- filter(df, smoker == 'no')

# Create a scatter plot for non-smokers
model_fig <- plot_ly(data = non_smoker_df, x = ~age, y = ~bmi, z = ~charges, 
                     type = 'scatter3d', mode = 'markers', 
                     marker = list(size = 3, opacity = 0.6, color ="blue"),
                    name = "Non-Smokers")

# Filter smoker data
smoker_df <- filter(df, smoker == 'yes')
model_fig <- add_trace(model_fig, data = smoker_df, x = ~age, y = ~bmi, z = ~charges,
                       type = 'scatter3d', mode = 'markers', 
                      marker = list(size = 3, opacity = 0.6, color ="red" ),
                       name = "Smokers")

# Customize layout
model_fig <- layout(model_fig, title = "Relation between Age, BMI, and Charges",
                    scene = list(xaxis = list(title = "Age"),
                                 yaxis = list(title = "BMI"),
                                 zaxis = list(title = "Charges")),
                    legend = list(title = "Legend"))

# Show the plot
model_fig

```









